

# 虚拟化相关概念

# 1. 虚拟化

借助虚拟化技术，用户能以单个物理硬件系统为基础，创建多个模拟环境或专用资源，并使用一款名为“Hypervisor”（虚拟机监控程序）的软件直接连接到硬件，从而将一个系统划分为不同、单独而安全的环境，即虚拟机 (VM)。

虚拟化技术可以重新划分IT资源，提高资源的利用率。

# 2. 虚拟化的类型

**全虚拟化（Full virtualization）**

全虚拟化使用未修改的guest操作系统版本，guest直接与CPU通信，是最快的虚拟化方法。

**半虚拟化（Paravirtualization）**

半虚拟化使用修改过的guest操作系统，guest与hypervisor通信，hypervisor将guest的调用传递给CPU和其他接口。因为通信经过hypervisor，因此比全虚拟化慢。

# 3. hypervisor

`hypervisor`又称为 **virtual machine monitor** (**VMM**)，是一个创建和运行虚拟机的程序。被 hypervisor 用来运行一个或多个虚拟机的计算机称为宿主机（`host machine`），这些虚拟机则称为客户机（`guest machine`）。

# 4. kvm

`kvm(Kernel-based Virtual Machine)`是Linux内核的虚拟化模块，可以利用Linux内核的功能来作为hypervisor。

KVM本身不进行模拟，而是暴露一个`/dev/kvm`接口。

使用KVM，可以在Linux的镜像上

[![img](./assets/68747470733a2f2f75706c6f61642e77696b696d656469612e6f72672f77696b6970656469612f636f6d6d6f6e732f352f35632f4b65726e656c2d62617365645f5669727475616c5f4d616368696e655f7a682d434e2e737667.svg+xml)](https://camo.githubusercontent.com/f9f491b5abca82554709766d98d372783f99ab1d8218e51aacc64a23728264d5/68747470733a2f2f75706c6f61642e77696b696d656469612e6f72672f77696b6970656469612f636f6d6d6f6e732f352f35632f4b65726e656c2d62617365645f5669727475616c5f4d616368696e655f7a682d434e2e737667)

# 5. qemu

**QEMU**（quick emulator）

> 待补充

# 6. libvirt

libvirt是一个硬件虚拟化的管理工具API，可用于KVM、QEMU等虚拟化技术，

[![img](./assets/68747470733a2f2f75706c6f61642e77696b696d656469612e6f72672f77696b6970656469612f636f6d6d6f6e732f642f64302f4c6962766972745f737570706f72742e737667.svg+xml)](https://camo.githubusercontent.com/e438281ed72f77ef7c692bcd7f53f272e56cda21660121d70193de62cf30b951/68747470733a2f2f75706c6f61642e77696b696d656469612e6f72672f77696b6970656469612f636f6d6d6f6e732f642f64302f4c6962766972745f737570706f72742e737667)

# KubeVirt

# KubeVirt的介绍

> 本文主要由[云原生虚拟化：基于 Kubevirt 构建边缘计算实例](https://mp.weixin.qq.com/s/IwA1QcGaooZAL96YjvTqjA)文章重新整理而成。

# 1. kubevirt简介

kubevirt是基于k8s之上，提供了一种通过k8s来编排和管理虚拟机的方式。

# 2. 架构图

[![arch](https://camo.githubusercontent.com/587877986993414768407b979f715b43ea917f6493901dec6731bff57b206605/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f647178746e3069636b2f696d6167652f75706c6f61642f76313635303030353639312f61727469636c652f6b756265726e657465732f6b756265766972742f6172636869746563747572652e706e67)](https://camo.githubusercontent.com/587877986993414768407b979f715b43ea917f6493901dec6731bff57b206605/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f647178746e3069636b2f696d6167652f75706c6f61642f76313635303030353639312f61727469636c652f6b756265726e657465732f6b756265766972742f6172636869746563747572652e706e67)

## 2.1. 组件说明

| 分类   | 组件            | 部署方式         | 功能说明                                                     |
| ------ | --------------- | ---------------- | ------------------------------------------------------------ |
| 控制面 | virt-api        | deployment       | 自定义API，开机、关机、重启等，作为apiserver的插件，业务通过k8s apiserver请求virt-api。 |
|        | virt-controller | deployment       | 管理和监控VMI对象的状态，控制VMI下的pod。                    |
| 节点侧 | virt-handler    | daemonset        | 类似kubelet，管理宿主机上的所有虚拟机实例。                  |
|        | virt-launcher   | virt-handler pod | 调用libvirt和qemu创建虚拟机进程。                            |

virt-launcher与libvirt逻辑：

[![img](https://camo.githubusercontent.com/302d0b3981de685d11d7a598e4229d51e199c72775e32cd16c8c1007d612b98b/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f647178746e3069636b2f696d6167652f75706c6f61642f76313635303237313232372f61727469636c652f6b756265726e657465732f6b756265766972742f766972742d6c61756e636865722e6a7067)](https://camo.githubusercontent.com/302d0b3981de685d11d7a598e4229d51e199c72775e32cd16c8c1007d612b98b/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f647178746e3069636b2f696d6167652f75706c6f61642f76313635303237313232372f61727469636c652f6b756265726e657465732f6b756265766972742f766972742d6c61756e636865722e6a7067)

## 2.2. 自定义CRD对象

| 分类 | CRD对象                       | 功能说明                                                     |
| ---- | ----------------------------- | ------------------------------------------------------------ |
| 虚机 | VirtualMachineInstance（VMI） | 代表运行的虚拟机实例                                         |
|      | VirtualMachine（VM）          | 虚机对象，提供开机、关机、重启，管理VMI实例，与VMI的关系是1：1 |
|      |                               |                                                              |

# 3. 创建虚拟机流程

> 待补充

# KubeVirt的使用



# 1. 安装kubevirt

## 1.1. 修改镜像仓库

针对私有环境，需要将所需镜像上传到自己的镜像仓库中。

涉及的镜像组件有

```
virt-operator
virt-api
virt-controller
virt-launcher
```



重命名镜像脚本如下:

```
#!/bin/bash

# kubevirt组件版本
version=$1

# 私有镜像仓库
registry=$2

# 私有镜像仓库的namespace
namespace=$3

kubevirtRegistry="quay.io/kubevirt"

readonly APPLIST=(
    virt-operator
    virt-api
    virt-controller
    virt-launcher
)

for app in "${APPLIST[@]}"; do
    # 拉取镜像
    docker pull ${kubevirtRegistry}/${app}:${version}
    # 重命名
    docker tag ${kubevirtRegistry}/${app}:${version} ${registry}/${namespace}/${app}:${version}
    # 推送镜像
    docker push ${registry}/${namespace}/${app}:${version}
done

echo "重新命名成功"
```



## 1.2. 部署virt-operator

通过kubevirt operator安装kubevirt相关组件，选择指定版本，下载`kubevirt-operator.yaml`和`kubevirt-cr.yaml`文件，并创建k8s相关对象。

> 如果是私有镜像仓库，则需要将kubevirt-operator.yaml文件中镜像的名字替换为私有镜像仓库的地址，并提前按步骤1推送所需镜像到私有镜像仓库。

```
# Pick an upstream version of KubeVirt to install
$ export RELEASE=v0.52.0
# Deploy the KubeVirt operator
$ kubectl apply -f https://github.com/kubevirt/kubevirt/releases/download/${RELEASE}/kubevirt-operator.yaml
# Create the KubeVirt CR (instance deployment request) which triggers the actual installation
$ kubectl apply -f https://github.com/kubevirt/kubevirt/releases/download/${RELEASE}/kubevirt-cr.yaml
# wait until all KubeVirt components are up
$ kubectl -n kubevirt wait kv kubevirt --for condition=Available
```



## 1.3. 部署virtctl

virtctl用来启动和关闭虚拟机。

```
VERSION=$(kubectl get kubevirt.kubevirt.io/kubevirt -n kubevirt -o=jsonpath="{.status.observedKubeVirtVersion}")
ARCH=$(uname -s | tr A-Z a-z)-$(uname -m | sed 's/x86_64/amd64/') || windows-amd64.exe
echo ${ARCH}
curl -L -o virtctl https://github.com/kubevirt/kubevirt/releases/download/${VERSION}/virtctl-${VERSION}-${ARCH}
chmod +x virtctl
sudo install virtctl /usr/local/bin
```



# 2. kubevirt部署产物

通过手动部署virt-operator，会自动部署以下组件

| 组件            | 部署方式   | 副本数 |
| --------------- | ---------- | ------ |
| virt-api        | deployment | 2      |
| virt-controller | deployment | 2      |
| virt-handler    | daemonset  | -      |

具体参考:

```
#kg all -n kubevirt
NAME                                   READY   STATUS    RESTARTS   AGE
pod/virt-api-5fb5cffb7f-hgjjh          1/1     Running   0          23h
pod/virt-api-5fb5cffb7f-jcp7x          1/1     Running   0          23h
pod/virt-controller-844cd4f58c-h8vsx   1/1     Running   0          23h
pod/virt-controller-844cd4f58c-vlxqs   1/1     Running   0          23h
pod/virt-handler-lb5ft                 1/1     Running   0          23h
pod/virt-handler-mtr4d                 1/1     Running   0          22h
pod/virt-handler-sxd2t                 1/1     Running   0          23h
pod/virt-operator-8595f577cd-b9txg     1/1     Running   0          23h
pod/virt-operator-8595f577cd-p2f69     1/1     Running   0          23h

NAME                                  TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
service/kubevirt-operator-webhook     ClusterIP   10.254.159.81    <none>        443/TCP   23h
service/kubevirt-prometheus-metrics   ClusterIP   10.254.7.231     <none>        443/TCP   23h
service/virt-api                      ClusterIP   10.254.244.139   <none>        443/TCP   23h

NAME                          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
daemonset.apps/virt-handler   3         3         3       3            3           kubernetes.io/os=linux   23h

NAME                              READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/virt-api          2/2     2            2           23h
deployment.apps/virt-controller   2/2     2            2           23h
deployment.apps/virt-operator     2/2     2            2           23h

NAME                                         DESIRED   CURRENT   READY   AGE
replicaset.apps/virt-api-5fb5cffb7f          2         2         2       23h
replicaset.apps/virt-controller-844cd4f58c   2         2         2       23h
replicaset.apps/virt-operator-8595f577cd     2         2         2       23h

NAME                            AGE   PHASE
kubevirt.kubevirt.io/kubevirt   23h   Deployed
```



# 3. 创建虚拟机

通过vm.yaml创建虚拟机

```
# 下载vm.yaml
wget https://kubevirt.io/labs/manifests/vm.yaml
# 创建虚拟机
kubectl apply -f https://kubevirt.io/labs/manifests/vm.yaml
```



vm.yaml文件

```
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: testvm
spec:
  running: false
  template:
    metadata:
      labels:
        kubevirt.io/size: small
        kubevirt.io/domain: testvm
    spec:
      domain:
        devices:
          disks:
            - name: containerdisk
              disk:
                bus: virtio
            - name: cloudinitdisk
              disk:
                bus: virtio
          interfaces:
          - name: default
            masquerade: {}
        resources:
          requests:
            memory: 64M
      networks:
      - name: default
        pod: {}
      volumes:
        - name: containerdisk
          containerDisk:
            image: quay.io/kubevirt/cirros-container-disk-demo
        - name: cloudinitdisk
          cloudInitNoCloud:
            userDataBase64: SGkuXG4=
```



查看虚拟机

```
kubectl get vms
kubectl get vms -o yaml testvm
```



启动或暂停虚拟机

```
# 启动虚拟机
virtctl start testvm
# 关闭虚拟机
virtctl stop testvm
# 进入虚拟机
virtctl console testvm
```



删除虚拟机

```
kubectl delete vm testvm
```