# 1、为什么需要 WebSocket？

我们已经有了 HTTP 协议，为什么还需要另一个协议？它能带来什么好处？
因为 HTTP 协议有一个缺陷：通信只能由客户端发起，不具备服务器推送能力。比如，我们想了解查询今天的实时数据，只能是客户端向服务器发出请求，服务器返回查询结果。

HTTP 协议做不到服务器主动向客户端推送信息。这种单向请求的特点，注定了如果服务器有连续的状态变化，客户端要获知就非常麻烦。

在WebSocket出现之前，我们只能使用"轮询"：每隔一段时候，就发出一个询问，了解服务器有没有新的信息。轮询的效率低，非常浪费资源。

**传统的实现即时通信的方式**

> **ajax轮询**
> ajax轮询的原理非常简单，让浏览器隔个几秒就发送一次请求，询问服务器是否有新信息。ajax轮询 需要服务器有很快的处理速度和资源。
>
> **long poll（长轮询）**
> long poll 其实原理跟 ajax轮询 差不多，都是采用轮询的方式，不过采取的是阻塞模型（一直打电话，没收到就不挂电话），也就是说，客户端发起连接后，如果没消息，就一直不返回Response给客户端。直到有消息才返回，返回完之后，客户端再次建立连接，周而复始。long poll 需要有很高的并发，也就是说同时接待客户的能力。

在 WebSocket 协议出现以前，创建一个和服务端进双通道通信的 web 应用，需要依赖HTTP协议，进行不停的轮询，这会导致一些问题：

- 服务端被迫维持来自每个客户端的大量不同的连接
- 大量的轮询请求会造成高开销。

因为http协议本身是没有持久通信能力的，但是我们在实际的应用中，是很需要这种能力的，所以为了解决这些问题，WebSocket 协议由此而生。


# 2、什么是 WebSocket

WebSocket协议是基于TCP的一种新的网络协议。它实现了浏览器与服务器全双工（full-duplex）通信，即允许服务器主动发送信息给客户端。因此，在WebSocket中，浏览器和服务器只需要完成一次握手，两者之间就直接可以创建持久性的连接，并进行双向数据传输，客户端和服务器之间的数据交换变得更加简单。

> **什么是单工、半双工、全工通信？**
>
> 信息只能单向传送为单工；
> 信息能双向传送但不能同时双向传送称为半双工；
> 信息能够同时双向传送则称为全双工。

在 WebSocket API 中，浏览器和服务器只需要完成一次握手，两者之间就直接可以创建持久性的连接， 并进行双向数据传输。

WebSocket 本质上一种计算机网络应用层的协议，用来弥补 http 协议在持久通信能力上的不足。现在最新版本浏览器都已经支持了。

> WebSocket 最大特点就是，服务器可以主动向客户端推送信息，客户端也可以主动向服务器发送信息，是真正的双向平等对话，属于服务器推送技术的一种。
>

WebSocket 的其他特点包括：

（1）建立在 TCP 协议之上，服务器端的实现比较容易。
（2）与 HTTP 协议有着良好的兼容性。默认端口也是80和443，并且握手阶段采用 HTTP 协议，因此握手时不容易屏蔽，能通过各种 HTTP 代理服务器。
（3）数据格式比较轻量，性能开销小，通信高效。
（4）可以发送文本，也可以发送二进制数据。
（5）没有同源限制，客户端可以与任意服务器通信。
（6）协议标识符是ws（如果加密，则为wss），服务器网址就是 URL。

# 3、WebSocket协议的原理

WebSocket是一种基于TCP协议的应用层协议，它通过在传输层协议之上实现全双工通信，实现了客户端和服务器之间的实时通信。WebSocket协议的主要特点是实现了双向通信、支持二进制数据传输和支持跨域通信。 

在客户端和服务器进行WebSocket通信前，需要通过HTTP协议建立连接。连接建立过程中，客户端发送一个HTTP请求到服务器，请求头中包含了WebSocket相关的信息，服务器收到请求后进行协议升级，将HTTP协议升级为WebSocket协议，同时返回响应头中包含了WebSocket相关的信息，客户端和服务器之间建立WebSocket连接。

连接建立后，客户端和服务器之间就可以进行双向通信，客户端和服务器可以随时向对方发送数据，不需要再进行HTTP协议的建立和释放。

通信结束后，客户端和服务器可以根据需要主动关闭连接。 

在WebSocket连接建立后，客户端和服务器之间的通信是基于帧(Frame)的。每个帧包含了一个数据片段，可以是文本数据或二进制数据，同时还包含了一些控制信息，用于协商连接状态、数据传输等。

帧可以分为控制帧和数据帧。

控制帧用于控制连接状态，例如关闭连接、心跳等；数据帧用于传输数据。

总之，WebSocket协议通过在传输层协议之上实现全双工通信，实现了客户端和服务器之间的实时通信。

它具有双向通信、支持二进制数据传输和支持跨域通信等特点，是实现实时通信的一种重要技术手段。